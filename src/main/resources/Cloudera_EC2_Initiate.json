{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "EC2 instance launch script for installing cloudera manager",
    "Parameters": {
        "VPC": {
        "Description": "Just select the one and only default VPC.",
        "Type": "AWS::EC2::VPC::Id"
    	},
    	"Subnet": {
    	"Description": "The subnet the instance will be launched",
    	"Type": "AWS::EC2::Subnet::Id"
    	},
    	"InstanceType": {
    	"Description": "The instance type",
    	"Type": "String",
    	"Default": "m3.xlarge"
    	},
    	"KeyName":{
    	"Description":"The key used to launch the EC2",
    	"Type":"AWS::EC2::KeyPair::KeyName",
    	"Default":"emorybio"
    	}
    },
    "Mappings": {
        "EC2RegionMap": {
            "ap-northeast-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-cbf90ecb"},
            "ap-southeast-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-68d8e93a"},
            "ap-southeast-2": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-fd9cecc7"},
            "eu-central-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-a8221fb5"},
            "eu-west-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-a10897d6"},
            "sa-east-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-b52890a8"},
            "us-east-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-1ecae776"},
            "us-west-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-d114f295"},
            "us-west-2": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-e7527ed7"}
        }
    },
    "Resources": {
        "EC2Instance" : {
            "Type": "AWS::EC2::Instance",
            "Properties": {
            	"InstanceType" : { "Ref" : "InstanceType" },
                "SecurityGroupIds" :[{"Ref":"ClouderaEC2InstallerSecurityGroup"}],
                "ImageId": "ami-fb6463ec",
                "SubnetId":{ "Ref":"Subnet"},
               
                "KeyName":{"Ref":"KeyName"},
                "UserData":{"Fn::Base64":{"Fn::Join":["",["#!/bin/bash -ex\n",
                "sudo wget http://archive.cloudera.com/cm5/installer/latest/cloudera-manager-installer.bin\n",
                "sudo chmod +x cloudera-manager-installer.bin"]]}}
            }
        },
        
        "ClouderaEC2InstallerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "cloudera-ec2-sg",
                "VpcId": {"Ref": "VPC"},
                "SecurityGroupIngress": [{
                                         "CidrIp": "0.0.0.0/0",
                                         "FromPort": "22",
                                         "IpProtocol": "tcp",
                                         "ToPort": "22"
                                         },
                                         {
                                          "IpProtocol": "tcp",
                                           "FromPort": "7180",
                                         "ToPort": "7183",
                                         "CidrIp":"0.0.0.0/0"
                                         },
                                           {
                                          "IpProtocol": "tcp",
                                           "FromPort":"7432",
                                         "ToPort": "7432",
                                         "CidrIp":"0.0.0.0/0"
                                         },
                                         { "IpProtocol": "icmp",
                                           "FromPort":"-1",
                                         "ToPort": "-1",
                                         "CidrIp":"0.0.0.0/0"
                                         }
                                         ]
            }
        }
        
        },
        
    "Outputs": {
	        "ServerIp": {
	     		"Description": "Public Ip of the instance",   
	            "Value":{ "Fn::GetAtt" : [ "EC2Instance", "PublicIp" ] }
	        } 
        }
    
    }