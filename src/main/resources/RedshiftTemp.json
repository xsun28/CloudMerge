{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS Redshift Test",
    "Parameters": {
        
        "DBName": {
            "Description": "The default database name.",
            "Type": "String",
            "Default": "test"
        },
        "MasterUsername": {
            "Description": "A username for admin.",
            "Type": "String",
            "Default": "xsun28",
             "AllowedPattern" : "([a-z])([a-z]|[0-9])*"
        },
        "MasterUserPassword": {
            "Description": "A password for admin",
            "Type": "String",
            "NoEcho": "true"
        },
        "VPC": {
        "Description": "Just select the one and only default VPC.",
        "Type": "AWS::EC2::VPC::Id"
    	},
    	"NodeNumber":{
    	"Description":"Number of Nodes in multinode mode",
    	"Type": "Number",
    	"Default": "1"
    	},
    	"ClusterType": {
    	"Description": "The type of the cluster",
    	"Type":"String",
    	"Default":"single-node",
    	"AllowedValues": ["single-node","multi-node"]
    	},
    	"NodeType" : {
      	"Description" : "The type of node to be provisioned",
      	"Type" : "String",
      	"Default" : "dw1.xlarge",
      	"AllowedValues" : [ "dw1.xlarge", "dw1.8xlarge", "dw2.large", "dw2.8xlarge" ]
    	}
    },
    "Mappings": {
        "EC2RegionMap": {
            "ap-northeast-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-cbf90ecb"},
            "ap-southeast-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-68d8e93a"},
            "ap-southeast-2": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-fd9cecc7"},
            "eu-central-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-a8221fb5"},
            "eu-west-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-a10897d6"},
            "sa-east-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-b52890a8"},
            "us-east-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-1ecae776"},
            "us-west-1": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-d114f295"},
            "us-west-2": {"AmazonLinuxAMIHVMEBSBacked64bit": "ami-e7527ed7"}
        }
    },
    "Conditions" : {
    "IsMultiNodeCluster" : {
      "Fn::Equals" : [{ "Ref" : "ClusterType" }, "multi-node" ]        
    	}
  	},
    "Resources": {
        "RedshiftCluster" : {
            "Type": "AWS::Redshift::Cluster",
            "Properties": {
            	"DBName" : { "Ref" : "DBName" },
                "MasterUsername" : {"Ref":"MasterUsername"},
                "MasterUserPassword" : { "Ref" : "MasterUserPassword" },
                "ClusterType" : { "Ref" : "ClusterType" },
                "NodeType" : { "Ref" : "NodeType" },
                "NumberOfNodes":{"Fn::If":["IsMultiNodeCluster",{"Ref":"NodeNumber"},{"Ref":"AWS::NoValue"}]},
                "PubliclyAccessible": "true",
                "VpcSecurityGroupIds" :[{"Ref":"RedShiftSecurityGroup"}]
            }
        },
        
        "RedShiftSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "redshift-sg",
                "VpcId": {"Ref": "VPC"},
                "SecurityGroupIngress": [{
                                         "CidrIp": "0.0.0.0/0",
                                         "FromPort": 5439,
                                         "IpProtocol": "tcp",
                                         "ToPort": 5439
                                         }]
            }
        }
        
        },
        
    "Outputs": {
	        "ClusterEndpoint": {
	     		"Description": "Cluster Endpoint",   
	            "Value": {"Fn::Join": [":", [{ "Fn::GetAtt" : [ "RedshiftCluster", "Endpoint.Address" ] }, { "Fn::GetAtt" : [ "RedshiftCluster", "Endpoint.Port" ] } ] ] }
	        },
        "ClusterName" : {
            "Description" : "Name of cluster",
            "Value" : { "Ref" : "RedshiftCluster" }
        }
        
        }
    
    }